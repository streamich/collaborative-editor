"use strict";(self.webpackChunkcollaborative_editor=self.webpackChunkcollaborative_editor||[]).push([[375],{"./src/InputFacade.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Facade0:()=>Facade0,Facade0Textarea:()=>Facade0Textarea,Facade1:()=>Facade1,Facade1Textarea:()=>Facade1Textarea,Facade2:()=>Facade2,Facade2Textarea:()=>Facade2Textarea,Facade3:()=>Facade3,Facade3Textarea:()=>Facade3Textarea,Facade4:()=>Facade4,Facade4Textarea:()=>Facade4Textarea,__namedExportsOrder:()=>__namedExportsOrder,default:()=>__WEBPACK_DEFAULT_EXPORT__});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),_StrBinding__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./src/StrBinding.ts"),_InputFacade__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./src/InputFacade.ts"),_tests_fixtures__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./src/__tests__/fixtures.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/react/jsx-runtime.js");const Demo=_ref=>{let{textarea,Facade}=_ref;const inputRef=react__WEBPACK_IMPORTED_MODULE_0__.useRef(null),[model,clone]=react__WEBPACK_IMPORTED_MODULE_0__.useMemo((()=>{const model=_tests_fixtures__WEBPACK_IMPORTED_MODULE_3__.o.clone();return[model,model.clone()]}),[1]);return react__WEBPACK_IMPORTED_MODULE_0__.useSyncExternalStore(model.api.subscribe,(()=>model.tick)),react__WEBPACK_IMPORTED_MODULE_0__.useEffect((()=>{if(!inputRef.current)return;const input=inputRef.current,editor=new Facade(input),binding=new _StrBinding__WEBPACK_IMPORTED_MODULE_1__.z((()=>model.api.str([])),editor);return binding.bind(!0),()=>{binding.unbind()}}),[model]),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsxs)("div",{children:[textarea?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)("textarea",{ref:inputRef}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)("input",{ref:inputRef,type:"text"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)("div",{children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)("button",{onClick:()=>{const input=inputRef.current;input&&(input.value+="!")},children:'Append "!" to input'})}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)("div",{children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)("button",{onClick:()=>{const str=model.api.str([]);str.ins(str.view().length,"?")},children:'Append "?" to model'})}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)("div",{children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)("button",{onClick:()=>{setTimeout((()=>{const str=model.api.str([]);str.ins(str.view().length,"?")}),2e3)},children:'Append "?" to model after 2s'})}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)("div",{children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)("button",{onClick:()=>{setTimeout((()=>{model.api.str([]).ins(0,"1. ")}),2e3)},children:'Prepend "1. " to model after 2s'})}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)("div",{children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)("button",{onClick:()=>{setTimeout((()=>{model.reset(clone)}),2e3)},children:"RESET after 2s"})}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)("pre",{style:{fontSize:"10px"},children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)("code",{children:model.root+""})})]})};Demo.displayName="Demo";const __WEBPACK_DEFAULT_EXPORT__={title:"InputFacade",component:Demo,argTypes:{}},Facade0={args:{Facade:_InputFacade__WEBPACK_IMPORTED_MODULE_2__.pl}},Facade0Textarea={args:{Facade:_InputFacade__WEBPACK_IMPORTED_MODULE_2__.pl,textarea:!0}},Facade1={args:{Facade:_InputFacade__WEBPACK_IMPORTED_MODULE_2__.i4}},Facade1Textarea={args:{Facade:_InputFacade__WEBPACK_IMPORTED_MODULE_2__.i4,textarea:!0}},Facade2={args:{Facade:_InputFacade__WEBPACK_IMPORTED_MODULE_2__.pM}},Facade2Textarea={args:{Facade:_InputFacade__WEBPACK_IMPORTED_MODULE_2__.pM,textarea:!0}},Facade3={args:{Facade:_InputFacade__WEBPACK_IMPORTED_MODULE_2__.iJ}},Facade3Textarea={args:{Facade:_InputFacade__WEBPACK_IMPORTED_MODULE_2__.iJ,textarea:!0}},Facade4={args:{Facade:_InputFacade__WEBPACK_IMPORTED_MODULE_2__.pr}},Facade4Textarea={args:{Facade:_InputFacade__WEBPACK_IMPORTED_MODULE_2__.pr,textarea:!0}};Facade0.parameters={...Facade0.parameters,docs:{...Facade0.parameters?.docs,source:{originalSource:"{\n  args: ({\n    Facade: InputFacade0\n  } as any)\n}",...Facade0.parameters?.docs?.source}}},Facade0Textarea.parameters={...Facade0Textarea.parameters,docs:{...Facade0Textarea.parameters?.docs,source:{originalSource:"{\n  args: ({\n    Facade: InputFacade0,\n    textarea: true\n  } as any)\n}",...Facade0Textarea.parameters?.docs?.source}}},Facade1.parameters={...Facade1.parameters,docs:{...Facade1.parameters?.docs,source:{originalSource:"{\n  args: ({\n    Facade: InputFacade1\n  } as any)\n}",...Facade1.parameters?.docs?.source}}},Facade1Textarea.parameters={...Facade1Textarea.parameters,docs:{...Facade1Textarea.parameters?.docs,source:{originalSource:"{\n  args: ({\n    Facade: InputFacade1,\n    textarea: true\n  } as any)\n}",...Facade1Textarea.parameters?.docs?.source}}},Facade2.parameters={...Facade2.parameters,docs:{...Facade2.parameters?.docs,source:{originalSource:"{\n  args: ({\n    Facade: InputFacade2\n  } as any)\n}",...Facade2.parameters?.docs?.source}}},Facade2Textarea.parameters={...Facade2Textarea.parameters,docs:{...Facade2Textarea.parameters?.docs,source:{originalSource:"{\n  args: ({\n    Facade: InputFacade2,\n    textarea: true\n  } as any)\n}",...Facade2Textarea.parameters?.docs?.source}}},Facade3.parameters={...Facade3.parameters,docs:{...Facade3.parameters?.docs,source:{originalSource:"{\n  args: ({\n    Facade: InputFacade3\n  } as any)\n}",...Facade3.parameters?.docs?.source}}},Facade3Textarea.parameters={...Facade3Textarea.parameters,docs:{...Facade3Textarea.parameters?.docs,source:{originalSource:"{\n  args: ({\n    Facade: InputFacade3,\n    textarea: true\n  } as any)\n}",...Facade3Textarea.parameters?.docs?.source}}},Facade4.parameters={...Facade4.parameters,docs:{...Facade4.parameters?.docs,source:{originalSource:"{\n  args: ({\n    Facade: InputFacade4\n  } as any)\n}",...Facade4.parameters?.docs?.source}}},Facade4Textarea.parameters={...Facade4Textarea.parameters,docs:{...Facade4Textarea.parameters?.docs,source:{originalSource:"{\n  args: ({\n    Facade: InputFacade4,\n    textarea: true\n  } as any)\n}",...Facade4Textarea.parameters?.docs?.source}}};const __namedExportsOrder=["Facade0","Facade0Textarea","Facade1","Facade1Textarea","Facade2","Facade2Textarea","Facade3","Facade3Textarea","Facade4","Facade4Textarea"]},"./src/InputFacade.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{i4:()=>InputFacade1,iJ:()=>InputFacade3,pM:()=>InputFacade2,pl:()=>InputFacade0,pr:()=>InputFacade4});class InputFacade0{constructor(input){this.input=input}get(){return this.input.value}set(text){this.input.value=text}}class InputFacade1 extends InputFacade0{onInput=e=>{this._onInput(e)};_onInput(){this.onchange?.()}constructor(input){super(input),this.input=input,input.addEventListener("input",this.onInput)}getLength(){return this.input.value.length}dispose(){this.input.removeEventListener("input",this.onInput)}}class InputFacade2 extends InputFacade1{constructor(input){super(input),this.input=input,document.addEventListener("selectionchange",this.onSelectionChange)}getSelection(){const input=this.input,{selectionStart,selectionEnd,selectionDirection}=input;return["number"==typeof selectionStart?selectionStart:-1,"number"==typeof selectionEnd?selectionEnd:-1,"backward"===selectionDirection?-1:"forward"===selectionDirection?1:0]}setSelection(start,end,direction){const input=this.input;input.selectionStart=start>-1?start:null,input.selectionEnd=end>-1?end:null,input.selectionDirection=-1===direction?"backward":1===direction?"forward":"none"}onSelectionChange=()=>{this.onselection?.()};dispose(){super.dispose(),document.removeEventListener("selectionchange",this.onSelectionChange)}}class InputFacade3 extends InputFacade2{_onInput(e){const event=e,{input}=this,{data,inputType,isComposing}=event;if(!isComposing){switch(inputType){case"insertText":{if(!data||1!==data.length)break;const{selectionStart,selectionEnd}=input;if(null===selectionStart||null===selectionEnd)break;if(selectionStart!==selectionEnd)break;if(selectionStart<=0)break;const selection=this.selection;if(selectionStart-data.length!==selection.start)break;if("number"!=typeof selection.end||"number"!=typeof selection.end)break;const remove=selection.end-selection.start,change=[selection.start,remove,data];return void this.onchange([change])}case"deleteContentBackward":{const{start,end}=this.selection;if("number"!=typeof start||"number"!=typeof end)break;const change=start===end?[start-1,1,""]:[start,end-start,""];return void this.onchange([change])}}this.onchange()}}constructor(input){super(input),this.input=input}}class InputFacade4 extends InputFacade3{ins(position,text){const selection=this.getSelection(),value=this.get(),next=value.slice(0,position)+text+value.slice(position);if(this.set(next),selection){let[start,end]=selection;const length=text.length;start>=position&&(start+=length),end>position&&(end+=length),this.setSelection(start,end,selection[2])}}del(position,length){const selection=this.getSelection(),value=this.get(),next=value.slice(0,position)+value.slice(position+length);if(this.set(next),selection){let[start,end]=selection;start>=position&&(start=Math.max(position,start-length)),end>=position&&(end=Math.max(position,end-length)),this.setSelection(start,end,selection[2])}}}},"./src/StrBinding.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{z:()=>StrBinding});const applyChange=(view,position,remove,insert)=>view.slice(0,position)+insert+view.slice(position+remove);class Selection{start=null;end=null;dir=0;ts=0;tick=0;startId=null;endId=null}const diff=__webpack_require__("./node_modules/fast-diff/diff.js");var DIFF_CHANGE_TYPE=function(DIFF_CHANGE_TYPE){return DIFF_CHANGE_TYPE[DIFF_CHANGE_TYPE.DELETE=-1]="DELETE",DIFF_CHANGE_TYPE[DIFF_CHANGE_TYPE.EQUAL=0]="EQUAL",DIFF_CHANGE_TYPE[DIFF_CHANGE_TYPE.INSERT=1]="INSERT",DIFF_CHANGE_TYPE}(DIFF_CHANGE_TYPE||{});class StrBinding{static bind=(str,editor,polling)=>{const binding=new StrBinding(str,editor);return binding.syncFromModel(),binding.bind(polling),binding.unbind};race=(()=>{let invoked=!1;return fn=>{if(!invoked){invoked=!0;try{fn()}finally{invoked=!1}}}})();constructor(str,editor){this.str=str,this.editor=editor,this.view=str().view(),editor.selection=this.selection=new Selection}saveSelection(){const{editor,selection}=this,str=this.str(),[selectionStart,selectionEnd,selectionDirection]=editor.getSelection?.()||[-1,-1,0],{start,end}=selection,now=Date.now(),tick=str.api.model.tick;start===selectionStart&&end===selectionEnd&&(tick===selection.tick||now-selection.ts<3e3)||(selection.start=selectionStart,selection.end=selectionEnd,selection.dir=selectionDirection,selection.ts=now,selection.tick=tick,selection.startId="number"==typeof selectionStart?str.findId((selectionStart??0)-1)??null:null,selection.endId="number"==typeof selectionEnd?str.findId((selectionEnd??0)-1)??null:null)}syncFromModel(){const editor=this.editor,str=this.str(),view=this.view=str.view();if(editor.ins&&editor.del){const editorText=editor.get();if(view===editorText)return;const changes=diff(editorText,view),changeLen=changes.length;let pos=0;for(let i=0;i<changeLen;i++){const change=changes[i],[type,text]=change,len=text.length;switch(type){case DIFF_CHANGE_TYPE.DELETE:editor.del(pos,len);break;case DIFF_CHANGE_TYPE.EQUAL:pos+=len;break;case DIFF_CHANGE_TYPE.INSERT:editor.ins(pos,text),pos+=len}}}else{editor.set(view);const{selection}=this;if(editor.setSelection){const start=selection.startId?str.findPos(selection.startId)+1:-1,end=selection.endId?str.findPos(selection.endId)+1:-1;editor.setSelection(start,end,selection.dir)}}}onModelChange=()=>{this.race((()=>{this.syncFromModel(),this.saveSelection()}))};syncFromEditor(){let view=this.view;const value=this.editor.get();if(value===view)return;const selection=this.selection,caretPos=selection.start===selection.end?selection.start??void 0:void 0,changes=diff(view,value,caretPos),changeLen=changes.length,str=this.str();str.api.transaction((()=>{let pos=0;for(let i=0;i<changeLen;i++){const change=changes[i],[type,text]=change;switch(type){case DIFF_CHANGE_TYPE.DELETE:view=applyChange(view,pos,text.length,""),str.del(pos,text.length);break;case DIFF_CHANGE_TYPE.EQUAL:pos+=text.length;break;case DIFF_CHANGE_TYPE.INSERT:view=applyChange(view,pos,0,text),str.ins(pos,text),pos+=text.length}}})),this.view=view,this.saveSelection()}onchange=(changes,verify)=>{this.race((()=>{if(changes instanceof Array&&changes.length>0){const str=this.str();let applyChanges=!0;if(verify){let view=this.view;for(let i=0;i<length;i++){const change=changes[i],[position,remove,insert]=change;view=applyChange(view,position,remove,insert)}const editor=this.editor;editor.getLength&&view.length!==editor.getLength()||view!==editor.get()?applyChanges=!1:this.view=view}if(applyChanges){const length=changes.length;try{return str.api.transaction((()=>{let view=this.view;for(let i=0;i<length;i++){const change=changes[i],[position,remove,insert]=change;view=applyChange(view,position,remove,insert),remove&&str.del(position,remove),insert&&str.ins(position,insert)}this.view=view})),void this.saveSelection()}catch{}}}this.syncFromEditor()}))};pollingInterval=1e3;_p=null;pollChanges=()=>{this._p=setTimeout((()=>{this.race((()=>{try{const view=this.view,editor=this.editor;(!!editor.getLength&&view.length!==editor.getLength()||view!==editor.get())&&this.syncFromEditor()}catch{}this._p&&this.pollChanges()}))}),this.pollingInterval)};stopPolling(){this._p&&clearTimeout(this._p),this._p=null}_s=null;bind=polling=>{this.syncFromModel();const editor=this.editor;editor.onchange=this.onchange,editor.onselection=()=>this.saveSelection(),polling&&this.pollChanges(),this._s=this.str().api.onChange.listen(this.onModelChange)};unbind=()=>{this.stopPolling(),this._s?.(),this.editor.dispose?.()}}},"./src/__tests__/fixtures.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{o:()=>model0});var json_joy_lib_json_crdt__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/json-joy/lib/json-crdt/index.js");const model0=json_joy_lib_json_crdt__WEBPACK_IMPORTED_MODULE_0__.Model.create(json_joy_lib_json_crdt__WEBPACK_IMPORTED_MODULE_0__.s.str("Hello"))}}]);