"use strict";(self.webpackChunkcollaborative_editor=self.webpackChunkcollaborative_editor||[]).push([[707],{"./src/StrBinding.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Input:()=>Input,Textarea:()=>Textarea,__namedExportsOrder:()=>__namedExportsOrder,default:()=>StrBinding_stories});var react=__webpack_require__("./node_modules/react/index.js"),json_crdt=__webpack_require__("./node_modules/json-joy/es2020/json-crdt/index.js");const applyChange=(str,_ref)=>{let[position,remove,insert]=_ref;return str.slice(0,position)+insert+str.slice(position+remove)};class Selection{start=null;end=null;dir=0;ts=0;tick=0;startId=null;endId=null}const diff=__webpack_require__("./node_modules/fast-diff/diff.js");var DIFF_CHANGE_TYPE=function(DIFF_CHANGE_TYPE){return DIFF_CHANGE_TYPE[DIFF_CHANGE_TYPE.DELETE=-1]="DELETE",DIFF_CHANGE_TYPE[DIFF_CHANGE_TYPE.EQUAL=0]="EQUAL",DIFF_CHANGE_TYPE[DIFF_CHANGE_TYPE.INSERT=1]="INSERT",DIFF_CHANGE_TYPE}(DIFF_CHANGE_TYPE||{});class StrBinding{race=(()=>{let invoked=!1;return fn=>{if(!invoked){invoked=!0;try{fn()}finally{invoked=!1}}}})();constructor(str,editor){this.str=str,this.editor=editor,editor.selection=this.selection=new Selection}saveSelection(){const{str,editor,selection}=this,[selectionStart,selectionEnd,selectionDirection]=editor.getSelection()||[-1,-1,0],{start,end}=selection,now=Date.now(),tick=str.api.model.tick;start===selectionStart&&end===selectionEnd&&(tick===selection.tick||now-selection.ts<3e3)||(selection.start=selectionStart,selection.end=selectionEnd,selection.dir=selectionDirection,selection.ts=now,selection.tick=tick,selection.startId="number"==typeof selectionStart?str.findId((selectionStart??0)-1)??null:null,selection.endId="number"==typeof selectionEnd?str.findId((selectionEnd??0)-1)??null:null)}syncFromModel(){this.editor.set(this.str.view())}onModelChange=()=>{this.race((()=>{this.syncFromModel();const{editor,selection,str}=this,start=selection.startId?str.findPos(selection.startId)+1:-1,end=selection.endId?str.findPos(selection.endId)+1:-1;editor.setSelection(start,end,selection.dir),this.saveSelection()}))};syncFromEditor(){const{str,editor}=this,view=str.view(),value=editor.get();if(value===view)return;const selection=this.selection,caretPos=selection.start===selection.end?selection.start??void 0:void 0,changes=diff(view,value,caretPos),changeLen=changes.length;let pos=0;for(let i=0;i<changeLen;i++){const change=changes[i],[type,text]=change;switch(type){case DIFF_CHANGE_TYPE.DELETE:str.del(pos,text.length);break;case DIFF_CHANGE_TYPE.EQUAL:pos+=text.length;break;case DIFF_CHANGE_TYPE.INSERT:str.ins(pos,text),pos+=text.length}}}onchange=changes=>{this.race((()=>{if(changes){let expected=this.str.view();for(const change of changes)expected=applyChange(expected,change);const editor=this.editor;if(expected.length===editor.getLength()&&expected===editor.get()){const str=this.str;for(const change of changes){const[position,remove,insert]=change;remove&&str.del(position,remove),insert&&str.ins(position,insert)}return}}this.syncFromEditor(),this.saveSelection()}))};pollingInterval=1e3;_p=null;pollChanges=()=>{this._p=setTimeout((()=>{this.race((()=>{try{const view=this.str.view(),editor=this.editor;(view.length!==editor.getLength()||view!==editor.get())&&this.syncFromEditor()}catch{}this._p&&this.pollChanges()}))}),this.pollingInterval)};stopPolling(){this._p&&clearTimeout(this._p),this._p=null}_s=null;bind=polling=>{this.syncFromModel();const editor=this.editor;editor.onchange=this.onchange,editor.onselection=()=>this.saveSelection(),polling&&this.pollChanges(),this._s=this.str.api.onChange.listen(this.onModelChange)};unbind=()=>{this.stopPolling(),this._s?.(),this.editor.dispose()}}class SimpleHtmlInputEditor{constructor(input){this.input=input,input.addEventListener("input",this.onInput),document.addEventListener("selectionchange",this.onSelectionChange)}get(){return this.input.value}getLength(){return this.input.value.length}set(text){this.input.value=text}getSelection(){const input=this.input,{selectionStart,selectionEnd,selectionDirection}=input;return["number"==typeof selectionStart?selectionStart:-1,"number"==typeof selectionEnd?selectionEnd:-1,"backward"===selectionDirection?-1:"forward"===selectionDirection?1:0]}setSelection(start,end,direction){const input=this.input;input.selectionStart=start>-1?start:null,input.selectionEnd=end>-1?end:null,input.selectionDirection=-1===direction?"backward":1===direction?"forward":"none"}onInput=()=>{this.onchange()};onSelectionChange=()=>{this.onselection()};dispose(){this.input.removeEventListener("input",this.onInput),document.removeEventListener("selectionchange",this.onSelectionChange)}}var jsx_runtime=__webpack_require__("./node_modules/react/jsx-runtime.js");const Demo=_ref=>{let{textarea}=_ref;const inputRef=react.useRef(null),[model,clone]=react.useMemo((()=>{const model=json_crdt.Model.withLogicalClock();return model.api.root({text:"Hell"}),[model,model.clone()]}),[1]);return react.useSyncExternalStore(model.api.subscribe,(()=>model.tick)),react.useEffect((()=>{if(!inputRef.current)return;const input=inputRef.current,editor=new SimpleHtmlInputEditor(input),binding=new StrBinding(model.api.str(["text"]),editor);return binding.bind(!0),()=>{binding.unbind()}}),[model]),(0,jsx_runtime.jsxs)("div",{children:[textarea?(0,jsx_runtime.jsx)("textarea",{ref:inputRef}):(0,jsx_runtime.jsx)("input",{ref:inputRef,type:"text"}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{const input=inputRef.current;input&&(input.value+="!")},children:'Append "!" to input'})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{const str=model.api.str(["text"]);str.ins(str.view().length,"?")},children:'Append "?" to model'})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{setTimeout((()=>{const str=model.api.str(["text"]);str.ins(str.view().length,"?")}),2e3)},children:'Append "?" to model after 2s'})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{setTimeout((()=>{model.api.str(["text"]).ins(0,"1. ")}),2e3)},children:'Prepend "1. " to model after 2s'})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{setTimeout((()=>{model.reset(clone)}),2e3)},children:"RESET after 2s"})}),(0,jsx_runtime.jsx)("pre",{style:{fontSize:"10px"},children:(0,jsx_runtime.jsx)("code",{children:model.root+""})})]})};Demo.displayName="Demo";const StrBinding_stories={title:"StrBinding",component:Demo,argTypes:{}},Input={args:{}},Textarea={args:{textarea:!0}};Input.parameters={...Input.parameters,docs:{...Input.parameters?.docs,source:{originalSource:"{\n  args: {}\n}",...Input.parameters?.docs?.source}}},Textarea.parameters={...Textarea.parameters,docs:{...Textarea.parameters?.docs,source:{originalSource:"{\n  args: ({\n    textarea: true\n  } as any)\n}",...Textarea.parameters?.docs?.source}}};const __namedExportsOrder=["Input","Textarea"]}}]);